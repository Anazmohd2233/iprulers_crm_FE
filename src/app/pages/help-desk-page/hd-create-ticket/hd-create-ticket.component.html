<!-- Breadcrumb -->
<div class="breadcrumb-card mb-25 d-md-flex align-items-center justify-content-between">
    <h5 class="mb-0">

        {{ editMode ? 'Edit Task' : 'Create Task' }}
    </h5>
    <ol class="breadcrumb list-unstyled mt-0 mb-0 pl-0">
        <li class="breadcrumb-item position-relative">
            <a routerLink="/crm" class="d-inline-block position-relative">
                <i class="ri-home-8-line"></i>
                Dashboard
            </a>
        </li>
        <li class="breadcrumb-item position-relative">
            Task
        </li>
        <li class="breadcrumb-item position-relative">

            {{ editMode ? 'Edit Task' : 'Create Task' }}
        </li>
    </ol>
</div>

<!-- Create Task -->
<mat-card class="daxa-card create-project-card mb-25 border-radius bg-white border-none d-block"
    [class.rtl-enabled]="themeService.isRTLEnabled()">
    <mat-card-header>
        <mat-card-title>
            <h5 class="mb-0">
                {{ editMode ? 'Update Task' : 'Create New Task' }}
            </h5>
        </mat-card-title>
    </mat-card-header>
    <mat-card-content>
        <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
            <div class="row">
                <div class="col-lg-8">

                    <!-- <mat-card class="daxa-card sales-overview-card mb-25 border-radius bg-primary border-none d-block"
                        *ngIf="editMode">
                        <mat-card-content>
                            <h5 class="text-white">
                                Lead Progress
                            </h5>
                            <div class="sales-overview-info d-flex align-items-center justify-content-between">
                                <div>
                                    <span class="sub-title d-block text-white">
                                        Total Students
                                    </span>
                                    <span class="number d-block text-white fw-medium lh-1">
                                        {{taskSchool?.strength}}
                                    </span>
                                </div>
                                <div>
                                    <span class="sub-title d-block text-white">
                                        Collected Leads
                                    </span>
                                    <span class="number d-block text-white fw-medium lh-1">
                                        {{contactCount}}
                                    </span>
                                </div>
                                <div>
                                    <span class="sub-title d-block text-white">
                                        Pending
                                    </span>
                                    <span class="number d-block text-white fw-medium lh-1">
                                        {{ getRemainingSeats() }}
                                    </span>
                                </div>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" [style.width.%]="progress"></div>
                            </div>
                           
                        </mat-card-content>
                    </mat-card> -->
                    <div class="row">

                        <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    Lead
                                </label>
                                <mat-form-field>
                                    <mat-label>
                                        Select
                                    </mat-label>
                                    <!-- 'multiple' for multiple select -->
                                    <mat-select formControlName="lead_id">
                                        <mat-option *ngFor="let user of school" [value]="user.id">
                                            {{ user.customer_name }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    Task Title *
                                </label>
                                <mat-form-field>
                                    <mat-label>
                                        Enter task title
                                    </mat-label>
                                    <input matInput placeholder="Enter task title" formControlName="task_title">
                                    <mat-error *ngIf="task_title?.invalid && task_title?.touched">
                                        <span *ngIf="task_title?.errors?.['required']">Task title is required</span>
                                      ]
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>
                        <!-- <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    School Name
                                </label>

                                <mat-form-field>
                                    <mat-label>
                                        Select
                                    </mat-label>
                                    <mat-select multiple formControlName="school_name" *ngIf="!editMode">
                                        <mat-option *ngFor="let school of school" [value]="school.id">
                                            {{ school.school_name }}
                                        </mat-option>
                                    </mat-select>

                                    <mat-select formControlName="school_name_edit" *ngIf="editMode">
                                        <mat-option *ngFor="let school of school" [value]="school.id">
                                            {{ school.school_name }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>



                            </div>
                        </div> -->

                        <!-- <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    School Location
                                </label>
                                <mat-form-field>
                                    <mat-label>
                                        Enter School Location
                                    </mat-label>
                                    <input matInput formControlName="location">
                                </mat-form-field>
                            </div>
                        </div> -->

                        <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    Priority *
                                </label>
                                <mat-form-field>
                                    <mat-label>
                                        Select
                                    </mat-label>
                                    <mat-select formControlName="priority">
                                        <mat-option value="None">
                                            None
                                        </mat-option>
                                        <mat-option value="Low">
                                            Low
                                        </mat-option>
                                        <mat-option value="Medium">
                                            Medium
                                        </mat-option>
                                        <mat-option value="High">
                                            High
                                        </mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="priority?.invalid && priority?.touched">
                                        Priority is required
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </div>

                        <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    Assign to
                                </label>
                                <mat-form-field>
                                    <mat-label>
                                        Select
                                    </mat-label>
                                    <!-- 'multiple' for multiple select -->
                                    <mat-select formControlName="assigned_to">
                                        <mat-option *ngFor="let user of users" [value]="user.id">
                                            {{ user.name }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                        </div>
                        <div class="col-md-4 col-sm-6 mb-25">
                            <div class="mb-25">
                                <label class="main-label d-block lh-1 text-black">
                                    Due date *
                                </label>
                                <div class="row">
                                    <div class="col-9">
                                        <mat-form-field>
                                            <mat-label>
                                                Choose a date
                                            </mat-label>
                                            <input matInput [matDatepicker]="dueDatePicker" formControlName="due_date">
                                            <mat-datepicker-toggle matIconSuffix
                                                [for]="dueDatePicker"></mat-datepicker-toggle>
                                            <mat-datepicker #dueDatePicker></mat-datepicker>
                                            <mat-error *ngIf="due_date?.invalid && due_date?.touched">
                                                Due date is required
                                            </mat-error>
                                        </mat-form-field>
                                    </div>
                                    <!-- <div class="col-3">
                                        <mat-form-field appearance="fill">
                                            <input matInput placeholder="12hr format" [ngxTimepicker]="picker" formControlName="due_time">
                                            <i class="material-symbols-outlined mr-15" matSuffix>
                                                schedule
                                            </i>
                                            <ngx-material-timepicker #picker></ngx-material-timepicker>
                                        </mat-form-field>
                                    </div> -->
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="col-lg-4">



                    <div class="col-md-12 col-sm-06">
                        <div class="mb-25">
                            <mat-form-field appearance="outline" class="w-100">
                                <mat-label>Notes</mat-label>
                                <textarea matInput id="description" rows="4" formControlName="note"
                                    placeholder="Enter description">
                                    </textarea>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="col-md-12 col-sm-06 mb-25" *ngIf="editMode">
                        <label class="main-label d-block lh-1 text-black">
                            Task Status
                        </label>
                        <div class="col-md-12 col-sm-12">
                            <div class="mb-25">
                           

                                <mat-form-field appearance="outline" class="w-100">
                                    <mat-label>Select</mat-label>
                                    <mat-select #activitySelect multiple
                                        (selectionChange)="onActivityChange($event, activitySelect)">
                                        <mat-option *ngFor="let val of taskActivityValues" [value]="val">
                                            {{ val | titlecase }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>

                            </div>
                        </div>




                        <mat-card-content class="example-badges mt-15 mb-25">
                            <span class="badge text-bg-primary me-2" *ngIf="taskData?.data_collected">Task Completed</span>
                            <!-- <span class="badge text-bg-success me-2" *ngIf="taskData?.class_conducted">Class
                                conducted</span>
                            <span class="badge text-bg-warning" *ngIf="taskData?.data_collected">Data
                                collected</span> -->
                        </mat-card-content>
                    </div> 

                    <!-- <div class="btn-box">
                <button mat-button type="button" (click)="openDialog()" *ngIf="editMode">
                 
                    <span>Add Expence</span>
                </button>
        
            </div> -->
                </div>

            </div>
            <div class="btn-box mt-25">
                <button mat-button type="submit" [disabled]="isSubmitting">
                    <span *ngIf="isSubmitting">Creating...</span>
                    <span *ngIf="!isSubmitting">{{ editMode ? 'Update' : 'Create Task' }}</span>
                </button>
                <button mat-button type="button" (click)="openDialog()" *ngIf="editMode">

                    <span>Add Log</span>
                </button>

                <!-- <button mat-button type="button" (click)="openDialog_add_student()" *ngIf="editMode">

                    <span>Add Student</span>
                </button> -->
                <!-- <button mat-button type="button" (click)="onCancel()">
                    Cancel
                </button> -->

            </div>
        </form>
    </mat-card-content>
</mat-card>




<!-- Angular Material Dialog Template -->
<ng-template #taskDialog>
    <h2 mat-dialog-title>Create Log</h2>
    <mat-dialog-content>
        <form *ngIf="expenceForm" [formGroup]="expenceForm" (ngSubmit)="createExpence()">
            <div formArrayName="expenses">

                <div *ngFor="let expense of expenses.controls; let i = index" [formGroupName]="i"
                    class="row border p-2 mb-25 rounded">

                    <!-- 🔹 Communication Log -->
                    <h5 class="mb-3">Communication Log</h5>

                    <div class="row">
                        <div class="col-lg-8">
                                <div class="row">
                            <!-- Calling Date & Time -->
                            <div class="col-md-4 col-sm-6 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Calling Date</mat-label>
                                    <input matInput [matDatepicker]="callDate" formControlName="calling_date">
                                    <mat-datepicker-toggle matIconSuffix [for]="callDate"></mat-datepicker-toggle>
                                    <mat-datepicker #callDate></mat-datepicker>
                                </mat-form-field>
                            </div>

                            <!-- Communication Type -->
                            <div class="col-md-4 col-sm-6 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Communication Type</mat-label>
                                    <mat-select formControlName="communication_type">
                                        <mat-option value="call">Call</mat-option>
                                        <mat-option value="whatsapp">WhatsApp</mat-option>
                                        <mat-option value="email">Email</mat-option>
                                        <mat-option value="sms">SMS</mat-option>
                                        <mat-option value="meeting">Meeting</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Call Status -->
                            <div class="col-md-4 col-sm-6 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Call Status</mat-label>
                                    <mat-select formControlName="call_status">
                                        <mat-option value="connected">Connected</mat-option>
                                        <mat-option value="not_reachable">Not Reachable</mat-option>
                                        <mat-option value="no_answer">No Answer</mat-option>
                                        <mat-option value="busy">Busy</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Student Response -->
                            <div class="col-md-4 col-sm-6 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Student Response</mat-label>
                                    <mat-select formControlName="student_response">
                                        <mat-option value="positive">+ve</mat-option>
                                        <mat-option value="neutral">Neutral</mat-option>
                                        <mat-option value="negative">-ve</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Student Interest Level -->
                            <div class="col-md-4 col-sm-6 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Student Interest Level</mat-label>
                                    <mat-select formControlName="interest_level">
                                        <mat-option value="high">High</mat-option>
                                        <mat-option value="medium">Medium</mat-option>
                                        <mat-option value="low">Low</mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <!-- Comments / Notes -->
                            <div class="col-md-8 col-sm-12 mb-25">
                                <mat-form-field class="w-100">
                                    <mat-label>Comments / Notes</mat-label>
                                    <textarea matInput formControlName="comments" rows="3"></textarea>
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <!-- 🔹 Follow-up Tracking -->
                    <h5 class="mt-4 mb-3">Follow-up Tracking</h5>

                    <div class="row">
                        <!-- Next Call / Meeting Date -->
                        <div class="col-md-4 col-sm-6 mb-25">
                            <mat-form-field class="w-100">
                                <mat-label>Next Call / Meeting Date</mat-label>
                                <input matInput [matDatepicker]="nextCall" formControlName="next_call_date">
                                <mat-datepicker-toggle matIconSuffix [for]="nextCall"></mat-datepicker-toggle>
                                <mat-datepicker #nextCall></mat-datepicker>
                            </mat-form-field>
                        </div>
                    </div>

                    <!-- <div class="col-md-3 d-flex align-items-center">
                        <button mat-icon-button color="warn" (click)="removeExpense(i)" *ngIf="expenses.length > 1">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div> -->

                </div>
            </div>


            <mat-dialog-actions align="end" class="w-100">
                <div class="row">
                    <!-- <div class="col-md-6 col-sm-6 mb-25">
                        <button mat-button class="warn-btn" type="button" (click)="addExpense()">Add More</button>

                    </div> -->
                    <div class="col-md-6 col-sm-6 mb-25">
                        <button mat-raised-button class="success-btn" type="submit">Save</button>

                    </div>

                </div>
                <!-- <button mat-button class="warn-btn mb-25" type="button" (click)="addExpense()">Add More</button>
                <button mat-raised-button class="success-btn" type="submit">Save All</button> -->
            </mat-dialog-actions>







        </form>
    </mat-dialog-content>

    <mat-dialog-actions>
        <button mat-button mat-dialog-close>Cancel</button>
    </mat-dialog-actions>



</ng-template>




<ng-template #taskDialog_student>
    <h2 mat-dialog-title>Create Student</h2>
    <mat-dialog-content>
        <form *ngIf="studentForm" [formGroup]="studentForm" (ngSubmit)="createStudent()">
            <div formArrayName="students">

                <div *ngFor="let student of students.controls; let i = index" [formGroupName]="i"
                    class="row border p-2 mb-25 rounded">



                    <div class="col-md-5 col-sm-5 mb-25">
                        <mat-form-field class="w-100">
                            <mat-label>Student Name</mat-label>
                            <input matInput formControlName="student_name">
                        </mat-form-field>
                    </div>

                    <div class="col-md-5 col-sm-5 mb-25">
                        <mat-form-field class="w-100">
                            <mat-label>Phone</mat-label>
                            <input matInput formControlName="student_phone">
                        </mat-form-field>
                    </div>


                    <div class="col-md-2 col-sm-2 d-flex align-items-center">
                        <button mat-icon-button color="warn" (click)="removeStudent(i)" *ngIf="students.length > 1">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                </div>
            </div>


            <mat-dialog-actions align="end" class="w-100">
                <!-- <button mat-button class="warn-btn" type="button" (click)="addStudent()">Add More</button> -->
                <button mat-raised-button class="success-btn" type="submit">Add Contacts</button>
            </mat-dialog-actions>







        </form>
    </mat-dialog-content>

    <mat-dialog-actions>
        <button mat-button mat-dialog-close>Cancel</button>
    </mat-dialog-actions>
</ng-template>





<!-- Contacts -->
<mat-card *ngIf="editMode" class="daxa-card contacts-list-card mb-25 border-radius bg-white border-none d-block"
    [class.rtl-enabled]="themeService.isRTLEnabled()">
    <mat-card-header>
        <mat-card-title>
            <h5 class="mb-0">Task Logs</h5>
            <!-- <form class="search-box position-relative">
                <i class="material-symbols-outlined">
                    search
                </i>
                <input type="text" class="input-search d-block w-100 border-none outline-0"
                    placeholder="Search expence..." (keyup)="applyFilter($event)" #input>
            </form> -->
        </mat-card-title>

    </mat-card-header>
    <mat-card-content>
        <div class="contacts-list-table">
            <div class="table-responsive">
                <table mat-table [dataSource]="dataSource" multiTemplateDataRows>

                    <!-- Date -->
                    <ng-container matColumnDef="calling_date">
                        <th mat-header-cell *matHeaderCellDef>Calling Date</th>
                        <td mat-cell *matCellDef="let element">{{element.calling_date}}</td>
                    </ng-container>

                    <!-- Food Expence -->
                    <ng-container matColumnDef="next_call_date">
                        <th mat-header-cell *matHeaderCellDef>Next Call Date</th>
                        <td mat-cell *matCellDef="let element">{{element.next_call_date}}</td>
                    </ng-container>

                    <!-- Other Expence -->
                    <ng-container matColumnDef="communication_type">
                        <th mat-header-cell *matHeaderCellDef>Communication</th>
                        <td mat-cell *matCellDef="let element">{{element.communication_type}}</td>
                    </ng-container>

                    <!-- Total KM -->
                    <ng-container matColumnDef="call_status">
                        <th mat-header-cell *matHeaderCellDef>Call Status</th>
                        <td mat-cell *matCellDef="let element">{{element.call_status}}</td>
                    </ng-container>

                    <!-- Travel Expence -->
                    <ng-container matColumnDef="student_response">
                        <th mat-header-cell *matHeaderCellDef>Student Response</th>
                        <td mat-cell *matCellDef="let element">{{element.student_response}}</td>
                    </ng-container>

                    <!-- Grand Total -->
                    <ng-container matColumnDef="interest_level">
                        <th mat-header-cell *matHeaderCellDef>Interest Level</th>
                        <td mat-cell *matCellDef="let element">{{element.interest_level}}</td>
                    </ng-container>
                    <ng-container matColumnDef="comments">
                        <th mat-header-cell *matHeaderCellDef>Comments</th>
                        <td mat-cell *matCellDef="let element">{{element.comments}}</td>
                    </ng-container>

                    <!-- Action (Expand/Collapse) -->
                    <ng-container matColumnDef="action">
                        <th mat-header-cell *matHeaderCellDef>Action</th>
                        <td mat-cell *matCellDef="let element">
                            <button mat-icon-button (click)="toggleExpand(element)">
                                <mat-icon matTooltip="Show Details">
                                    {{expandedElement === element ? 'expand_less' : 'expand_more'}}
                                </mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <!-- Template for details -->
                    <ng-container matColumnDef="expandedDetail">
                        <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
                            <div class="p-3 bg-light" *ngIf="expandedElement === element">
                                <p>{{element.comments}}</p>

                            </div>
                        </td>
                    </ng-container>

                    <!-- Parent Row -->
                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="element-row"
                        [class.expanded]="expandedElement === row">
                    </tr>

                    <!-- Expanded Detail Row -->
                    <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row">
                    </tr>






                    <!-- No Data Row -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell" colspan="6">No logs found.</td>
                    </tr>

                </table>
            </div>
            <!-- <mat-paginator [length]="totalRecords" [pageSize]="20" showFirstLastButtons>
            </mat-paginator> -->
        </div>
    </mat-card-content>
</mat-card>